// Global Variables
let passages = [];
let currentPassageIndex = 0;
let timer;
let timeLeft = 180; // 3 minutes

// DOM Elements
const startButton = document.getElementById("start-game-btn");
const submitButton = document.getElementById("submit-btn");
const nextButton = document.getElementById("next-btn");
const timerElement = document.getElementById("timer");
const passageContainer = document.getElementById("passage-container");
const feedbackContainer = document.getElementById("feedback-container");
const goodLuckMessage = document.getElementById("good-luck-message");

// Fetch Passages from JSON
async function fetchPassages() {
  try {
    const response = await fetch("passages.json");
    if (!response.ok) throw new Error("Failed to fetch passages.");
    passages = await response.json();
  } catch (error) {
    alert("Unable to load passages. Please try again later.");
    console.error(error);
  }
}

// Start Game
function startGame() {
  setButtonVisibility({ start: false, submit: true });
  goodLuckMessage.classList.add("hidden");
  timerElement.classList.remove("hidden");
  passageContainer.classList.remove("hidden");

  timeLeft = 180;
  currentPassageIndex = 0;
  startTimer();
  loadPassage(currentPassageIndex);
}

// Timer Logic
function startTimer() {
  timerElement.textContent = formatTime(timeLeft);
  timer = setInterval(() => {
    timeLeft--;
    timerElement.textContent = formatTime(timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timer);
      submitAnswers();
    }
  }, 1000);
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes}:${secs < 10 ? "0" : ""}${secs}`;
}

// Load a Passage
function loadPassage(index) {
  const passage = passages[index];
  passageContainer.innerHTML = `
    <h2>${passage.title}</h2>
    <p>${renderTextWithBlanks(passage.text_with_blanks)}</p>
  `;
  feedbackContainer.classList.add("hidden");
  setButtonVisibility({ submit: true, next: false });

  const inputs = passageContainer.querySelectorAll("input");
  inputs.forEach((input, idx) => {
    input.addEventListener("input", () => {
      if (input.value.length === input.maxLength && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }
    });
  });
}

function renderTextWithBlanks(text) {
  return text.replace(/_/g, '<input type="text" maxlength="1">');
}

// Submit Answers
function submitAnswers() {
  clearInterval(timer);

  const passage = passages[currentPassageIndex];
  const inputs = passageContainer.querySelectorAll("input");
  let correctCount = 0;

  inputs.forEach((input, idx) => {
    const userAnswer = input.value.toLowerCase();
    const correctAnswers = passage.answer_mapping[`i_${idx + 1}`] || [];
    if (correctAnswers.includes(userAnswer)) {
      input.classList.add("correct");
      correctCount++;
    } else {
      input.classList.add("incorrect");
    }
  });

  const total = inputs.length;
  const percentage = ((correctCount / total) * 100).toFixed(2);

  feedbackContainer.innerHTML = `
    <p>You got ${correctCount} out of ${total} correct (${percentage}%).</p>
  `;
  feedbackContainer.classList.remove("hidden");
  setButtonVisibility({ submit: false, next: true });
}

// Load Next Passage
function loadNextPassage() {
  currentPassageIndex++;
  if (currentPassageIndex < passages.length) {
    timeLeft = 180;
    startTimer();
    loadPassage(currentPassageIndex);
  } else {
    endGame();
  }
}

// End Game
function endGame() {
  passageContainer.innerHTML = `<h2>Congratulations! You completed all passages.</h2>`;
  timerElement.classList.add("hidden");
  setButtonVisibility({ start: true, submit: false, next: false });
}

// Set Button Visibility
function setButtonVisibility({ start = false, submit = false, next = false }) {
  startButton.classList.toggle("hidden", !start);
  submitButton.classList.toggle("hidden", !submit);
  nextButton.classList.toggle("hidden", !next);
}

// Initialize
window.onload = async () => {
  await fetchPassages();
  startButton.addEventListener("click", startGame);
  submitButton.addEventListener("click", submitAnswers);
  nextButton.addEventListener("click", loadNextPassage);
};
